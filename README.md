# copulapop

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)

**Fit and Generate Realistic Virtual Patient Populations Using Vine Copulas**

copulapop creates virtual patient populations for pharmacometric modeling, PBPK simulations, and clinical trial simulations. It uses R-Vine copulas to preserve complex correlation structures and tail dependencies between covariates.

## Features

- **Fit your own copulas** - Create vine copulas from any dataset
- **Vine copula-based generation** - Captures asymmetric dependencies and tail behaviors
- **Multiple international datasets** - Pre-fitted models for 7 populations
- **Age-sex stratified models** - Separate copulas for demographic subgroups
- **Derived variable calculation** - BMI, BSA, eGFR (CKD-EPI 2021, Schwartz)
- **Validation reports** - Automated PDF reports to assess copula fit quality

## Repository Structure

```
copulapop/
├── R/
│   ├── data_path.R      # Path management functions
│   ├── fit.R            # Copula fitting functions (fit_copula, save_copula, etc.)
│   ├── generate.R       # Population generation functions
│   └── validate.R       # Validation report generation
├── data/                # Pre-fitted vine copula models (JSON)
│   ├── CHNS.json        # China Health and Nutrition Survey
│   ├── HSE.json         # Health Survey for England
│   ├── KNHANES.json     # Korea National Health and Nutrition Examination Survey
│   ├── NHANES.json      # US National Health and Nutrition Examination Survey
│   ├── RUMC.json        # Radboud University Medical Center
│   ├── RUMC_IC.json     # Radboud UMC Intensive Care
│   └── TANZANIA.json    # Tanzania Demographic and Health Survey
├── man/                 # Documentation (generated by roxygen2)
├── DESCRIPTION          # Package metadata
├── NAMESPACE            # Exported functions
├── LICENSE              # MIT License
└── README.md
```

## Installation

```r
# Install from GitHub
devtools::install_github("robterheine/copulapop")

# Or install dependencies first
install.packages(c("VineCopula", "data.table", "jsonlite", "Matrix", "MASS"))
devtools::install_github("robterheine/copulapop")
```

## Quick Start: Fit Your Own Copula

```r
library(copulapop)

# Load your data
my_data <- read.csv("hospital_data.csv")

# Fit a vine copula
copula <- fit_copula(
  my_data,
  name = "My Hospital",
  variables = c("AGE", "HEIGHT", "WEIGHT", "CREAT"),
  description = "Hospitalized patients 2020-2024"
)

# Generate virtual population
pop <- generate_population_from_copula(copula, n = 1000)
head(pop)

# Save for later use or sharing
save_copula(copula, "my_hospital.json")

# Load saved copula
copula <- load_copula("my_hospital.json")
```

## Quick Start: Use Pre-fitted Datasets

```r
library(copulapop)

# Set path to JSON data files
set_data_path("/path/to/copulapop/data/")

# List available datasets
list_datasets()

# Generate 1000 virtual patients
pop <- generate_population("RUMC", n = 1000)
head(pop)

# Generate specific subpopulations
adults <- generate_population("NHANES", n = 500, age_range = c(18, 65))
pediatric <- generate_population("CHNS", n = 200, age_range = c(2, 17))
females <- generate_population("HSE", n = 300, sex = "female")
```

## Functions Overview

### Copula Fitting
| Function | Description |
|----------|-------------|
| `fit_copula()` | Fit a vine copula from your own data |
| `save_copula()` | Save fitted copula to JSON file |
| `load_copula()` | Load copula from JSON file |
| `generate_population_from_copula()` | Generate population from copula object |

### Pre-fitted Datasets
| Function | Description |
|----------|-------------|
| `set_data_path()` | Set path to JSON data files |
| `list_datasets()` | List available pre-fitted datasets |
| `get_dataset_info()` | Get information about a dataset |
| `generate_population()` | Generate population from pre-fitted dataset |
| `generate_population_from_json()` | Generate population from JSON file path |

### Validation
| Function | Description |
|----------|-------------|
| `validate_copula()` | Generate PDF validation report |

## fit_copula() Details

```r
copula <- fit_copula(
  data,                          # Your data.frame
  name = "My Dataset",           # Name for the copula
  description = NULL,            # Optional description
  variables = c("AGE", "HEIGHT", "WEIGHT"),  # Variables to include
  sex_column = NULL,             # Column name for sex (auto-detected)
  height_in_cm = TRUE,           # Convert HEIGHT from cm to m
  country = NULL,                # Optional country
  source = NULL,                 # Optional data source
  adult_only = FALSE,            # Only fit adult strata
  n_quantiles = 1001,            # Quantiles for marginal distributions
  min_stratum_n = 50,            # Minimum N per stratum
  verbose = TRUE                 # Print progress
)
```

### Input Data Requirements

Your data should have:
- **AGE** column (required)
- **HEIGHT** column (in cm or m)
- **WEIGHT** column (in kg)
- **SEX** column (optional, 1/M/male = male, 0/F/female = female)
- Additional continuous variables (e.g., CREAT, ALBUMIN)

Column names are case-insensitive. The function automatically:
- Converts HEIGHT from cm to meters if needed
- Detects sex column (SEXISMALE, SEX, GENDER, MALE)
- Creates age-sex stratified copulas

## Output Variables

| Variable | Description | Unit |
|----------|-------------|------|
| ID | Patient identifier | - |
| SEXISMALE | Sex (1=male, 0=female) | - |
| AGE | Age | years |
| HEIGHT | Height | m |
| WEIGHT | Weight | kg |
| BMI | Body mass index | kg/m² |
| BSA | Body surface area | m² |
| CREAT | Serum creatinine* | µmol/L |
| EGFR | Estimated GFR* | mL/min/1.73m² |
| ALBUMIN | Serum albumin* | g/L |

\* If included in variables

## Pre-fitted Datasets

| Dataset | Country | Population | N | Age Range | Variables |
|---------|---------|------------|---|-----------|-----------|
| RUMC | Netherlands | Hospital patients | ~12,000 | 0–100 | AGE, HEIGHT, WEIGHT, CREAT |
| RUMC_IC | Netherlands | ICU patients (adults only) | ~3,000 | 18–100 | AGE, HEIGHT, WEIGHT, CREAT, ALBUMIN |
| CHNS | China | General population | ~25,000 | 0–100 | AGE, HEIGHT, WEIGHT |
| KNHANES | South Korea | General population | ~50,000 | 1–80 | AGE, HEIGHT, WEIGHT, CREAT |
| TANZANIA | Tanzania | Women 15–49, children 0–5 | ~22,000 | 0–49 | AGE, HEIGHT, WEIGHT |
| NHANES | USA | General population | ~40,000 | 0–80 | AGE, HEIGHT, WEIGHT, CREAT |
| HSE | UK | General population | ~45,000 | 0–90 | AGE, HEIGHT, WEIGHT |

**Note:** The JSON files in `data/` contain only statistical parameters (copula structure, quantiles), not individual-level data.

## Validation Reports

Generate comprehensive PDF validation reports:

```r
# Validate against source data
validate_copula(
  source_data = "my_data.csv",
  dataset = "my_copula.json",
  output_file = "validation.pdf"
)
```

The report includes:
- Executive summary with key metrics
- Descriptive statistics comparison
- Goodness-of-fit figures (percentiles, P-P plots)
- Correlation preservation assessment
- Distribution comparisons
- Conditional density heatmaps

### Validation Dependencies

```r
install.packages(c("rmarkdown", "knitr", "kableExtra", "ggplot2", 
                   "dplyr", "tidyr", "patchwork", "scales", "viridis"))
```

## eGFR Calculation

- **Adults (≥18 years)**: CKD-EPI 2021 race-free equation
- **Children (<18 years)**: Bedside Schwartz formula

## Citation

If you use copulapop in your research, please cite:

```
ter Heine R (2026). copulapop: Fit and Generate Virtual Populations Using Vine Copulas.
R package version 2.0.0. https://github.com/robterheine/copulapop
```

## Data Sources

| Dataset | Source | Reference |
|---------|--------|-----------|
| RUMC | Radboud University Medical Center | Internal |
| RUMC_IC | Radboud University Medical Center ICU | Internal |
| CHNS | China Health and Nutrition Survey | [cpc.unc.edu](https://www.cpc.unc.edu/projects/china) |
| KNHANES | Korea National Health and Nutrition Examination Survey | [knhanes.kdca.go.kr](https://knhanes.kdca.go.kr) |
| TANZANIA | Tanzania Demographic and Health Survey 2015-16 | [nbs.go.tz](https://www.nbs.go.tz) |
| NHANES | National Health and Nutrition Examination Survey | [cdc.gov/nchs/nhanes](https://www.cdc.gov/nchs/nhanes) |
| HSE | Health Survey for England 2015-2022 | [UK Data Service](https://digital.nhs.uk) |

## License

MIT License - see [LICENSE](LICENSE) for details.

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 2.0.0 | 2026-01-26 | Added `fit_copula()`, `save_copula()`, `load_copula()`, `generate_population_from_copula()` |
| 1.0.0 | 2026-01-20 | Initial release with pre-fitted datasets and validation |
